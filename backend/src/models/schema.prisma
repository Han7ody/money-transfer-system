// Prisma Schema
// backend/src/models/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  fullName      String   @map("full_name")
  email         String   @unique
  phone         String?   @unique
  passwordHash  String   @map("password_hash")
  role          Role     @default(USER)
  country       String
  isVerified    Boolean  @default(false) @map("is_verified")
  isActive      Boolean  @default(true) @map("is_active")

  // Notification Preferences
  notificationsOnEmail          Boolean  @default(true) @map("notifications_on_email")
  notificationsOnSms            Boolean  @default(true) @map("notifications_on_sms")
  notificationsOnTransactionUpdate Boolean  @default(true) @map("notifications_on_transaction_update")
  notificationsOnMarketing      Boolean  @default(false) @map("notifications_on_marketing")

  // Verification & Password Reset
  verificationOtp             String?   @map("verification_otp")
  verificationOtpExpiresAt    DateTime? @map("verification_otp_expires_at")
  passwordResetToken          String?   @unique @map("password_reset_token")
  passwordResetTokenExpiresAt DateTime? @map("password_reset_token_expires_at")

  // Profile fields (Step 2)
  city          String?
  dateOfBirth   DateTime? @map("date_of_birth")
  nationality   String?

  // KYC fields (Step 3)
  kycStatus     KycStatus @default(NOT_SUBMITTED) @map("kyc_status")
  kycDocuments  KycDocument[]
  kycSubmittedAt DateTime? @map("kyc_submitted_at")
  kycReviewedAt  DateTime? @map("kyc_reviewed_at")
  kycReviewedBy  Int?      @map("kyc_reviewed_by")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  transactions        Transaction[] @relation("UserTransactions")
  reviewedTransactions Transaction[] @relation("ReviewedBy")
  notifications       Notification[]
  auditLogs          AuditLog[]     @relation()
  updatedRates       ExchangeRate[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

model Currency {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  symbol    String?
  country   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  exchangeRatesFrom ExchangeRate[] @relation("FromCurrency")
  exchangeRatesTo   ExchangeRate[] @relation("ToCurrency")
  transactionsFrom  Transaction[] @relation("FromCurrency")
  transactionsTo    Transaction[] @relation("ToCurrency")

  @@map("currencies")
}

model ExchangeRate {
  id              Int      @id @default(autoincrement())
  fromCurrencyId  Int      @map("from_currency_id")
  toCurrencyId    Int      @map("to_currency_id")
  rate            Decimal  @db.Decimal(15, 6)
  adminFeePercent Decimal  @default(0) @map("admin_fee_percent") @db.Decimal(5, 2)
  updatedBy       Int?     @map("updated_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  fromCurrency Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])
  updater      User?    @relation(fields: [updatedBy], references: [id])

  @@unique([fromCurrencyId, toCurrencyId])
  @@map("exchange_rates")
}

model Transaction {
  id                    Int      @id @default(autoincrement())
  transactionRef        String   @unique @map("transaction_ref")
  userId                Int      @map("user_id")
  
  // Sender
  senderName            String   @map("sender_name")
  senderPhone           String   @map("sender_phone")
  senderCountry         String   @map("sender_country")
  
  // Recipient
  recipientName         String   @map("recipient_name")
  recipientPhone        String   @map("recipient_phone")
  recipientBankName     String?  @map("recipient_bank_name")
  recipientAccountNumber String? @map("recipient_account_number")
  recipientCountry      String   @map("recipient_country")
  
  // Amount
  fromCurrencyId        Int      @map("from_currency_id")
  toCurrencyId          Int      @map("to_currency_id")
  amountSent            Decimal  @map("amount_sent") @db.Decimal(15, 2)
  exchangeRate          Decimal  @map("exchange_rate") @db.Decimal(15, 6)
  adminFee              Decimal  @default(0) @map("admin_fee") @db.Decimal(15, 2)
  amountReceived        Decimal  @map("amount_received") @db.Decimal(15, 2)
  
  // Receipt
  receiptFilePath       String?  @map("receipt_file_path")
  receiptUploadedAt     DateTime? @map("receipt_uploaded_at")
  status                TransactionStatus @default(PENDING)
  
  // Admin Review
  reviewedBy            Int?     @map("reviewed_by")
  reviewedAt            DateTime? @map("reviewed_at")
  adminNotes            String?  @map("admin_notes")
  rejectionReason       String?  @map("rejection_reason")
  
  // Payment
  paymentMethod         String?  @map("payment_method")
  paymentReference      String?  @map("payment_reference")
  completedAt           DateTime? @map("completed_at")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user          User       @relation("UserTransactions", fields: [userId], references: [id])
  reviewer      User?      @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  fromCurrency  Currency   @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency    Currency   @relation("ToCurrency", fields: [toCurrencyId], references: [id])
  history       TransactionHistory[]
  notifications Notification[]

  @@index([userId])
  @@index([status])
  @@index([transactionRef])
  @@map("transactions")
}

enum TransactionStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

model TransactionHistory {
  id            Int      @id @default(autoincrement())
  transactionId Int      @map("transaction_id")
  oldStatus     String?  @map("old_status")
  newStatus     String   @map("new_status")
  changedBy     Int?     @map("changed_by")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@map("transaction_history")
}

model Notification {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  transactionId Int?     @map("transaction_id")
  title         String
  message       String
  isRead        Boolean  @default(false) @map("is_read")
  createdAt     DateTime @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([userId, isRead])
  @@map("notifications")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  adminId    Int?     @map("admin_id")
  action     String   // e.g. "UPDATE_EXCHANGE_RATES", "ADMIN_LOGIN", "UPDATE_SMTP"
  entity     String   // e.g. "SystemSettings", "ExchangeRates", "User", "Transaction"
  entityId   String?  @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  admin User? @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum KycStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
}

model KycDocument {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  type          String   // id_front, id_back, selfie
  filePath      String   @map("file_path")
  status        String   @default("pending") // pending, approved, rejected
  rejectionReason String? @map("rejection_reason")
  uploadedAt    DateTime @default(now()) @map("uploaded_at")
  reviewedAt    DateTime? @map("reviewed_at")

  user User @relation(fields: [userId], references: [id])

  @@map("kyc_documents")
}