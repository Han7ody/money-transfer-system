// Prisma Schema
// backend/src/models/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  fullName      String   @map("full_name")
  email         String   @unique
  phone         String   @unique
  passwordHash  String   @map("password_hash")
  role          Role     @default(USER)
  country       String
  isVerified    Boolean  @default(false) @map("is_verified")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  transactions        Transaction[] @relation("UserTransactions")
  reviewedTransactions Transaction[] @relation("ReviewedBy")
  notifications       Notification[]
  auditLogs          AuditLog[]
  updatedRates       ExchangeRate[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

model Currency {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  symbol    String?
  country   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  exchangeRatesFrom ExchangeRate[] @relation("FromCurrency")
  exchangeRatesTo   ExchangeRate[] @relation("ToCurrency")
  transactionsFrom  Transaction[] @relation("FromCurrency")
  transactionsTo    Transaction[] @relation("ToCurrency")

  @@map("currencies")
}

model ExchangeRate {
  id              Int      @id @default(autoincrement())
  fromCurrencyId  Int      @map("from_currency_id")
  toCurrencyId    Int      @map("to_currency_id")
  rate            Decimal  @db.Decimal(15, 6)
  adminFeePercent Decimal  @default(0) @map("admin_fee_percent") @db.Decimal(5, 2)
  updatedBy       Int?     @map("updated_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  fromCurrency Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])
  updater      User?    @relation(fields: [updatedBy], references: [id])

  @@unique([fromCurrencyId, toCurrencyId])
  @@map("exchange_rates")
}

model Transaction {
  id                    Int      @id @default(autoincrement())
  transactionRef        String   @unique @map("transaction_ref")
  userId                Int      @map("user_id")
  
  // Sender
  senderName            String   @map("sender_name")
  senderPhone           String   @map("sender_phone")
  senderCountry         String   @map("sender_country")
  
  // Recipient
  recipientName         String   @map("recipient_name")
  recipientPhone        String   @map("recipient_phone")
  recipientBankName     String?  @map("recipient_bank_name")
  recipientAccountNumber String? @map("recipient_account_number")
  recipientCountry      String   @map("recipient_country")
  
  // Amount
  fromCurrencyId        Int      @map("from_currency_id")
  toCurrencyId          Int      @map("to_currency_id")
  amountSent            Decimal  @map("amount_sent") @db.Decimal(15, 2)
  exchangeRate          Decimal  @map("exchange_rate") @db.Decimal(15, 6)
  adminFee              Decimal  @default(0) @map("admin_fee") @db.Decimal(15, 2)
  amountReceived        Decimal  @map("amount_received") @db.Decimal(15, 2)
  
  // Receipt
  receiptFilePath       String?  @map("receipt_file_path")
  receiptUploadedAt     DateTime? @map("receipt_uploaded_at")
  status                TransactionStatus @default(PENDING)
  
  // Admin Review
  reviewedBy            Int?     @map("reviewed_by")
  reviewedAt            DateTime? @map("reviewed_at")
  adminNotes            String?  @map("admin_notes")
  rejectionReason       String?  @map("rejection_reason")
  
  // Payment
  paymentMethod         String?  @map("payment_method")
  paymentReference      String?  @map("payment_reference")
  completedAt           DateTime? @map("completed_at")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user          User       @relation("UserTransactions", fields: [userId], references: [id])
  reviewer      User?      @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  fromCurrency  Currency   @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency    Currency   @relation("ToCurrency", fields: [toCurrencyId], references: [id])
  history       TransactionHistory[]
  notifications Notification[]

  @@index([userId])
  @@index([status])
  @@index([transactionRef])
  @@map("transactions")
}

enum TransactionStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

model TransactionHistory {
  id            Int      @id @default(autoincrement())
  transactionId Int      @map("transaction_id")
  oldStatus     String?  @map("old_status")
  newStatus     String   @map("new_status")
  changedBy     Int?     @map("changed_by")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@map("transaction_history")
}

model Notification {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  transactionId Int?     @map("transaction_id")
  title         String
  message       String
  isRead        Boolean  @default(false) @map("is_read")
  createdAt     DateTime @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([userId, isRead])
  @@map("notifications")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String
  tableName  String?  @map("table_name")
  recordId   Int?     @map("record_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}